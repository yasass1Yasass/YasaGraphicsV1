import{b as le,c as de,r as o,j as e,L as ce}from"./index-rPIBIrLb.js";const f=(...r)=>r.filter(Boolean).join(" "),me=(r="bk")=>`${r}_${Math.random().toString(36).slice(2,8)}${Date.now()}`,Q=(r,x)=>{try{const m=localStorage.getItem(r);return m?JSON.parse(m):x}catch{return x}},ue=(r,x)=>localStorage.setItem(r,JSON.stringify(x));function S(r){try{return new Intl.NumberFormat("en-GB",{style:"currency",currency:"GBP",maximumFractionDigits:0}).format(r)}catch{return`£${r}`}}function B(r){try{return new Date(r).toLocaleDateString("en-GB",{year:"numeric",month:"short",day:"numeric"})}catch{return r}}const xe="data:image/svg+xml;base64,"+btoa(`<svg xmlns='http://www.w3.org/2000/svg' width='800' height='500'>
      <defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>
        <stop offset='0%' stop-color='#059669'/><stop offset='100%' stop-color='#2563EB'/>
      </linearGradient></defs>
      <rect width='100%' height='100%' fill='url(#g)'/>
      <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle'
        font-family='Arial' font-size='26' fill='white' opacity='0.9'>EcoVenture</text>
    </svg>`);function fe({src:r,alt:x,className:m}){const[a,N]=o.useState(!0);return e.jsxs("div",{className:f("relative overflow-hidden bg-emerald-50",m),children:[e.jsx("img",{src:a&&r?r:xe,alt:x,loading:"lazy",onError:()=>N(!1),className:"h-full w-full object-cover"}),e.jsx("div",{"aria-hidden":!0,className:"pointer-events-none absolute inset-0 bg-gradient-to-t from-black/30 via-black/0"})]})}const he={id:"t1",title:"Lake District Ridgeway",category:"hiking",shortDescription:"Panoramic fell views across classic Lakeland scenery.",durationDays:3,location:"Lake District, England",nextStartDate:"2025-09-20",availableSlots:8,priceGBP:189,images:["https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1400&q=60","https://images.unsplash.com/photo-1469474968028-56623f02e42e?auto=format&fit=crop&w=1400&q=60"],rating:4.8,difficulty:"Moderate"};function pe(){var H,K;const{state:r}=le(),[x]=de(),m=x.get("id")||x.get("book")||((H=r==null?void 0:r.tour)==null?void 0:H.id),[a,N]=o.useState(he),[X,C]=o.useState(!1),[I,L]=o.useState(null);o.useEffect(()=>{let t=!1;async function l(){var d,u;if(L(null),r!=null&&r.tour){N(r.tour);return}if(m){const i=Q("custom_tours",[]).find(b=>b.id===m);if(i){N(i);return}}if(m){C(!0);try{const n=await fetch(`http://localhost:3001/api/tours/${m}`);if(!n.ok)throw new Error("Tour not found");const i=await n.json(),b={id:((d=i.id)==null?void 0:d.toString())??"",title:i.title??"Untitled Tour",category:"hiking",shortDescription:((u=i.description)==null?void 0:u.slice(0,80))??i.title??"",longDescription:i.description??i.title??"",durationDays:i.durationDays??1,location:i.location??"",nextStartDate:i.nextStartDate??"",availableSlots:i.availableSlots??0,priceGBP:Number(i.priceGBP)??0,images:Array.isArray(i.media)&&i.media.length>0?i.media.map(p=>p.url&&p.url.startsWith("/uploads/")?`http://localhost:3001${p.url}`:p.url):[],rating:4.8,difficulty:"Moderate"};t||N(b)}catch(n){t||L((n==null?void 0:n.message)||"Failed to load tour")}finally{t||C(!1)}return}}return l(),()=>{t=!0}},[r==null?void 0:r.tour,m]);const y=a.availableSlots<=0,[h,O]=o.useState(""),[g,F]=o.useState(""),[j,q]=o.useState(""),[v,Z]=o.useState(""),[c,A]=o.useState(1),[w,G]=o.useState(a.nextStartDate||""),[T,U]=o.useState(""),[$,ee]=o.useState(!1),[k,te]=o.useState(null),[ae,R]=o.useState(!1),[D,E]=o.useState("default");o.useEffect(()=>{if(typeof window>"u"||!("Notification"in window)){E("unsupported");return}E(Notification.permission)},[]);async function M(){if(!("serviceWorker"in navigator))return null;try{return await navigator.serviceWorker.ready}catch{return null}}async function V(t,l,d){try{if(typeof window>"u"||!("Notification"in window))return;let u=Notification.permission;if(u==="default"&&(u=await Notification.requestPermission()),u!=="granted")return;const n=await M();if(n&&n.showNotification){await n.showNotification("Booking confirmed — EcoVenture",{body:`${l.title} • ${l.location}
Booked by: ${d||"you"}
Ref: ${t.id}`,icon:"/favicon.ico",badge:"/favicon.ico",data:{url:"/tours"},requireInteraction:!0,renotify:!0,tag:`booking-${t.id}`});return}const i=new Notification("Booking confirmed — EcoVenture",{body:`${l.title} • ${l.location}
Booked by: ${d||"you"}
Ref: ${t.id}`,icon:"/favicon.ico",badge:"/favicon.ico",data:{url:"/tours"},requireInteraction:!0,tag:`booking-${t.id}`});i.onclick=()=>{window.focus()}}catch{}}async function se(){if(!("Notification"in window)){E("unsupported");return}try{const t=await Notification.requestPermission();if(E(t),t==="granted"){const l=await M();l&&l.showNotification?await l.showNotification("Notifications enabled — EcoVenture",{body:"You'll see booking confirmations here.",icon:"/favicon.ico",badge:"/favicon.ico",data:{url:"/tours"},requireInteraction:!0}):new Notification("Notifications enabled — EcoVenture",{body:"You'll see booking confirmations here.",icon:"/favicon.ico"})}}catch{}}o.useEffect(()=>{try{const t=localStorage.getItem("user");if(!t)return;const l=JSON.parse(t||"null");if(!l)return;if(l.email&&q(d=>d||l.email||""),l.name){const d=l.name.trim().split(/\s+/),u=d[0]||"",n=d.slice(1).join(" ");O(i=>i||u),F(i=>i||n)}}catch{}},[]),o.useEffect(()=>{c>a.availableSlots&&A(a.availableSlots||1)},[a.availableSlots,c]),o.useEffect(()=>{G(a.nextStartDate||"")},[a.nextStartDate]);const[s,z]=o.useState({}),re=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,ie=/^[0-9+()\-\s]{7,}$/;function J(){const t={};if((!h.trim()||h.trim().length<2)&&(t.first="Please enter your first name (min 2 chars)."),(!g.trim()||g.trim().length<2)&&(t.last="Please enter your last name (min 2 chars)."),(!j.trim()||!re.test(j.trim()))&&(t.email="Enter a valid email address."),v.trim()&&!ie.test(v.trim())&&(t.phone="Enter a valid phone number or leave blank."),(!c||isNaN(c)||c<1)&&(t.party="Party size must be at least 1."),a.availableSlots&&c>a.availableSlots&&(t.party=`Only ${a.availableSlots} slots left.`),!w)t.startDate="Select a start date.";else if(a.nextStartDate){const l=new Date(w),d=new Date(a.nextStartDate);l<d&&(t.startDate=`Choose ${B(a.nextStartDate)} or later.`)}return $||(t.agree="You must agree to the terms."),y&&(t.party="This tour is currently sold out."),t}o.useEffect(()=>{z(J())},[h,g,j,v,c,w,$,a.availableSlots,a.nextStartDate]);const W=a.priceGBP,Y=W*Math.max(1,c),P=Y,_=!y&&Object.keys(s).length===0;function ne(t){t.preventDefault();const l=J();if(z(l),Object.keys(l).length>0)return;const d={id:me(),tourId:a.id,tourTitle:a.title,startDate:w,party:c,customer:{first:h.trim(),last:g.trim(),email:j.trim(),phone:v.trim()},notes:T.trim(),totalDue:P,createdAt:new Date().toISOString()},u=Q("bookings",[]);ue("bookings",[d,...u]);try{const n=JSON.parse(localStorage.getItem("user")||"null"),i=n!=null&&n.email?`notices:${n.email}`:"notices",b=localStorage.getItem(i),p=b?JSON.parse(b):[],oe=[{id:d.id,text:`Booking confirmed: ${a.title} — ${a.location}${n!=null&&n.name?` (by ${n.name})`:""}`,time:"Just now",href:"/tours",unread:!0},...p].slice(0,50);localStorage.setItem(i,JSON.stringify(oe)),window.dispatchEvent(new Event("notices-updated"))}catch{}te(`Booking is successful. Thanks for choosing EcoVenture! Reference: ${d.id}`),R(!0),V(d,a,`${h} ${g}`.trim())}return e.jsxs("div",{className:"space-y-8 px-4 sm:px-6",children:[D!=="granted"&&D!=="unsupported"&&e.jsxs("div",{className:"rounded-xl bg-indigo-50 p-3 text-indigo-900 ring-1 ring-indigo-200",children:["Enable desktop notifications to see Windows toasts when your booking is confirmed. "," ",e.jsx("button",{onClick:se,className:"ml-1 inline-flex items-center rounded-lg bg-indigo-600 px-2 py-1 text-xs font-semibold text-white hover:bg-indigo-700",children:"Enable"})]}),D==="granted"&&e.jsxs("div",{className:"rounded-xl bg-emerald-50 p-3 text-emerald-900 ring-1 ring-emerald-200",children:["Desktop notifications are enabled. "," ",e.jsx("button",{onClick:()=>{var t;return V({id:"test"},a,(t=JSON.parse(localStorage.getItem("user")||"null")||{})==null?void 0:t.name)},className:"ml-1 inline-flex items-center rounded-lg bg-emerald-600 px-2 py-1 text-xs font-semibold text-white hover:bg-emerald-700",children:"Send test notification"})]}),D==="unsupported"&&e.jsx("div",{className:"rounded-xl bg-neutral-100 p-3 text-neutral-700 ring-1 ring-neutral-200",children:"Desktop notifications are not supported in this browser."}),ae&&k&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4",children:e.jsxs("div",{className:"w-full max-w-md rounded-2xl bg-white p-6 text-center shadow-xl ring-1 ring-black/10",children:[e.jsx("div",{className:"mx-auto flex size-12 items-center justify-center rounded-full bg-emerald-100 text-emerald-700",children:e.jsx("svg",{viewBox:"0 0 24 24",className:"h-7 w-7",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M20 6L9 17l-5-5"})})}),e.jsx("h3",{className:"mt-3 text-lg font-extrabold text-neutral-900",children:"Booking successful"}),e.jsx("p",{className:"mt-1 text-sm text-neutral-700",children:"Thanks for choosing EcoVenture."}),e.jsx("p",{className:"mt-2 text-sm text-neutral-700",children:k}),e.jsx("div",{className:"mt-5 flex justify-center gap-2",children:e.jsx("button",{onClick:()=>R(!1),className:"rounded-xl bg-emerald-600 px-4 py-2 text-sm font-semibold text-white hover:bg-emerald-700",children:"Close"})})]})}),X&&e.jsx("div",{className:"rounded-xl bg-emerald-50 p-3 text-emerald-800 ring-1 ring-emerald-200",children:"Loading tour…"}),I&&e.jsx("div",{className:"rounded-xl bg-rose-50 p-3 text-rose-800 ring-1 ring-rose-200",children:I}),e.jsx("section",{className:"rounded-2xl bg-gradient-to-br from-emerald-700 via-emerald-600 to-indigo-600 p-6 text-white ring-1 ring-black/10",children:e.jsxs("div",{className:"mx-auto max-w-7xl",children:[e.jsxs("p",{className:"inline-flex items-center gap-2 rounded-full bg-white/10 px-3 py-1 text-sm ring-1 ring-white/20",children:[e.jsx("span",{className:"inline-block size-2 rounded-full bg-emerald-300"})," ",a.category]}),e.jsx("h1",{className:"mt-2 text-3xl font-extrabold tracking-tight",children:a.title}),e.jsx("p",{className:"mt-1 text-emerald-50",children:a.shortDescription})]})}),e.jsxs("div",{className:"mx-auto grid max-w-7xl gap-8 lg:grid-cols-3",children:[e.jsxs("aside",{className:"lg:col-span-1",children:[e.jsxs("div",{className:"overflow-hidden rounded-2xl bg-white shadow-sm ring-1 ring-black/5",children:[e.jsx(fe,{src:(K=a.images)==null?void 0:K[0],alt:a.title,className:"h-48 w-full"}),e.jsxs("div",{className:"p-5",children:[e.jsxs("dl",{className:"grid grid-cols-2 gap-3 text-sm text-neutral-800",children:[e.jsxs("div",{className:"rounded-lg bg-neutral-50 p-2",children:[e.jsx("dt",{className:"text-neutral-500",children:"Location"}),e.jsx("dd",{className:"font-semibold",children:a.location})]}),e.jsxs("div",{className:"rounded-lg bg-neutral-50 p-2",children:[e.jsx("dt",{className:"text-neutral-500",children:"Duration"}),e.jsxs("dd",{className:"font-semibold",children:[a.durationDays," days"]})]}),e.jsxs("div",{className:"rounded-lg bg-neutral-50 p-2",children:[e.jsx("dt",{className:"text-neutral-500",children:"Next start"}),e.jsx("dd",{className:"font-semibold",children:B(a.nextStartDate)})]}),e.jsxs("div",{className:"rounded-lg bg-neutral-50 p-2",children:[e.jsx("dt",{className:"text-neutral-500",children:"Availability"}),e.jsx("dd",{className:f("font-semibold",y?"text-rose-700":a.availableSlots<=5?"text-amber-700":"text-emerald-700"),children:y?"Sold out":`${a.availableSlots} left`})]})]}),e.jsxs("div",{className:"mt-4 flex items-center justify-between",children:[e.jsxs("span",{className:"text-lg font-extrabold text-emerald-700",children:["from ",S(a.priceGBP)]}),e.jsxs("span",{"aria-label":`Rating ${a.rating} out of 5`,className:"inline-flex items-center gap-1 rounded-full bg-emerald-100 px-2.5 py-1 text-sm font-semibold text-emerald-800",children:["★ ",a.rating.toFixed(1)]})]})]})]}),e.jsxs("div",{className:"mt-6 rounded-2xl bg-white p-5 shadow-sm ring-1 ring-black/5",children:[e.jsx("h3",{className:"font-semibold text-neutral-900",children:"Price breakdown"}),e.jsxs("ul",{className:"mt-3 space-y-2 text-sm",children:[e.jsxs("li",{className:"flex items-center justify-between",children:[e.jsxs("span",{children:[S(W)," × ",c," ",c>1?"guests":"guest"]}),e.jsx("span",{className:"font-semibold",children:S(Y)})]}),e.jsxs("li",{className:"flex items-center justify-between text-neutral-600",children:[e.jsx("span",{children:"Tour protection & fees"}),e.jsx("span",{children:"Included"})]}),e.jsxs("li",{className:"mt-2 flex items-center justify-between border-t pt-2",children:[e.jsx("span",{className:"font-semibold",children:"Total due now"}),e.jsx("span",{className:"text-lg font-extrabold text-emerald-700",children:S(P)})]})]})]})]}),e.jsx("section",{className:"lg:col-span-2",children:e.jsxs("form",{onSubmit:ne,className:"rounded-2xl bg-white p-6 shadow-sm ring-1 ring-black/5",noValidate:!0,children:[k&&e.jsx("div",{className:"mb-4 rounded-xl bg-emerald-50 p-3 text-emerald-800 ring-1 ring-emerald-200",children:k}),e.jsx("h2",{className:"text-lg font-extrabold text-emerald-900",children:"Guest details"}),e.jsxs("div",{className:"mt-4 grid gap-4 sm:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"first",className:"text-sm font-semibold text-neutral-800",children:"First name *"}),e.jsx("input",{id:"first",value:h,onChange:t=>O(t.target.value),"aria-invalid":!!s.first,"aria-describedby":"first-err",className:f("mt-1 w-full rounded-xl border px-3 py-2 outline-none transition",s.first?"border-rose-400 focus:border-rose-500":"border-emerald-300 bg-white/90 focus:border-emerald-500"),required:!0}),s.first&&e.jsx("p",{id:"first-err",className:"mt-1 text-xs text-rose-600",children:s.first})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"last",className:"text-sm font-semibold text-neutral-800",children:"Last name *"}),e.jsx("input",{id:"last",value:g,onChange:t=>F(t.target.value),"aria-invalid":!!s.last,"aria-describedby":"last-err",className:f("mt-1 w-full rounded-xl border px-3 py-2 outline-none transition",s.last?"border-rose-400 focus:border-rose-500":"border-emerald-300 bg-white/90 focus:border-emerald-500"),required:!0}),s.last&&e.jsx("p",{id:"last-err",className:"mt-1 text-xs text-rose-600",children:s.last})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"email",className:"text-sm font-semibold text-neutral-800",children:"Email *"}),e.jsx("input",{id:"email",type:"email",value:j,onChange:t=>q(t.target.value),"aria-invalid":!!s.email,"aria-describedby":"email-err",className:f("mt-1 w-full rounded-xl border px-3 py-2 outline-none transition",s.email?"border-rose-400 focus:border-rose-500":"border-emerald-300 bg-white/90 focus:border-emerald-500"),required:!0}),s.email&&e.jsx("p",{id:"email-err",className:"mt-1 text-xs text-rose-600",children:s.email})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"phone",className:"text-sm font-semibold text-neutral-800",children:"Phone"}),e.jsx("input",{id:"phone",value:v,onChange:t=>Z(t.target.value),"aria-invalid":!!s.phone,"aria-describedby":"phone-err",className:f("mt-1 w-full rounded-xl border px-3 py-2 outline-none transition",s.phone?"border-rose-400 focus:border-rose-500":"border-emerald-300 bg-white/90 focus:border-emerald-500"),placeholder:"+44 7123 456789"}),s.phone&&e.jsx("p",{id:"phone-err",className:"mt-1 text-xs text-rose-600",children:s.phone})]})]}),e.jsx("h3",{className:"mt-6 text-lg font-extrabold text-emerald-900",children:"Trip details"}),e.jsxs("div",{className:"mt-3 grid gap-4 sm:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"party",className:"text-sm font-semibold text-neutral-800",children:"Party size *"}),e.jsx("input",{id:"party",type:"number",min:1,max:Math.max(1,a.availableSlots),value:c,onChange:t=>A(Math.max(1,Math.min(Number(t.target.value)||1,Math.max(1,a.availableSlots)))),"aria-invalid":!!s.party,"aria-describedby":"party-err",className:f("mt-1 w-full rounded-xl border px-3 py-2 outline-none transition",s.party?"border-rose-400 focus:border-rose-500":"border-emerald-300 bg-white/90 focus:border-emerald-500"),required:!0}),e.jsxs("p",{className:"mt-1 text-xs text-neutral-600",children:["Max ",a.availableSlots," remaining."]}),s.party&&e.jsx("p",{id:"party-err",className:"mt-1 text-xs text-rose-600",children:s.party})]}),e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx("label",{htmlFor:"start",className:"text-sm font-semibold text-neutral-800",children:"Start date *"}),e.jsx("input",{id:"start",type:"date",value:w,min:a.nextStartDate||void 0,onChange:t=>G(t.target.value),"aria-invalid":!!s.startDate,"aria-describedby":"start-err",className:f("mt-1 w-full rounded-xl border px-3 py-2 outline-none transition",s.startDate?"border-rose-400 focus:border-rose-500":"border-emerald-300 bg-white/90 focus:border-emerald-500"),required:!0}),e.jsxs("p",{className:"mt-1 text-xs text-neutral-600",children:["Suggested: ",B(a.nextStartDate)]}),s.startDate&&e.jsx("p",{id:"start-err",className:"mt-1 text-xs text-rose-600",children:s.startDate})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{htmlFor:"notes",className:"text-sm font-semibold text-neutral-800",children:"Notes (access, dietary, kit…)"}),e.jsx("textarea",{id:"notes",rows:4,value:T,onChange:t=>U(t.target.value),className:"mt-1 w-full rounded-xl border border-emerald-300 bg-white/90 px-3 py-2 outline-none transition focus:border-emerald-500",placeholder:"Anything we should know?"})]}),e.jsxs("label",{className:"mt-4 inline-flex items-start gap-3 text-sm",children:[e.jsx("input",{type:"checkbox",checked:$,onChange:t=>ee(t.target.checked),"aria-invalid":!!s.agree,"aria-describedby":"agree-err",className:"mt-0.5 size-4 rounded border-emerald-300 text-emerald-600 focus:ring-emerald-500"}),e.jsx("span",{className:"text-neutral-700",children:"I agree to EcoVenture’s booking terms and leave-no-trace policy."})]}),s.agree&&e.jsx("p",{id:"agree-err",className:"mt-1 text-xs text-rose-600",children:s.agree}),e.jsxs("div",{className:"mt-6 flex flex-wrap items-center gap-3",children:[e.jsx("button",{type:"submit",disabled:!_,className:f("rounded-2xl px-5 py-3 font-semibold shadow-sm focus:outline-none focus:ring-2",_?"bg-emerald-600 text-white hover:-translate-y-0.5 hover:bg-emerald-700 focus:ring-emerald-500":"cursor-not-allowed bg-neutral-200 text-neutral-500"),children:y?"Sold out":`Pay ${S(P)} & reserve`}),e.jsx(ce,{to:"/tours",className:"rounded-2xl border border-emerald-300 bg-white px-5 py-3 font-semibold text-emerald-700 transition hover:-translate-y-0.5 hover:bg-emerald-50",children:"Back to tours"})]})]})})]})]})}export{pe as default};
